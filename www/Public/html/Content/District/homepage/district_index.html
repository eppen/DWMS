<include file="./Public/html/Content/District/district_config.html" />
<script type="text/javascript">
DWMS_page_config.pageid = 0;
</script>
<div class="row">
    <div class="col-md-6">
        <div class="panel panel-primary">
    <div class="panel-heading">
        <h3 class="panel-title">（生产、运输、接受）企业统计图</h3>
    </div>
    <div class="panel-body">
        <div id="statistics_graph_enterprise_container"></div>
    </div>
</div>
    </div>
    <div class="col-md-6">
       <div class="panel panel-primary">
    <div class="panel-heading">
        <h3 class="panel-title">本区企业信息统计表</h3>
    </div>
    <div class="panel-body">
        <table class="table" id="statistics_table_enterprise_container">
        </table>
    </div>
</div>
    </div>
</div>
<div class="row">
    <div class="col-md-12">
         <div class="panel panel-primary">
          <div class="panel-heading">
            <h3 class="panel-title">（转移联单及其危废重量）危废统计图</h3>
          </div>
          <div class="panel-body">   
            <div id="statistics_graph_waste_container"></div>
          </div>
</div>
    </div>
   <!--  <div class="col-md-6">
        <div class="panel panel-primary">
    <div class="panel-heading">
        <h3 class="panel-title">（转移联单及其危废重量）危废统计表</h3>
    </div>
    <div class="panel-body">
        <table class="table" id="statistics_table_waste_container">
        </table>
    </div>
</div>
    </div> -->
</div>
<div class="row">
    <div class="col-md-12">
         <div class="panel panel-primary">
          <div class="panel-heading">
            <h3 class="panel-title">（转移联单及其危废重量）危废统计图</h3>
          </div>
          <div class="panel-body">   
            <div id="statistics_graph_waste_container_2"></div>
          </div>
</div>
    </div>
</div>


<script type="text/javascript">
var p_number, r_number, t_number, sum, tong_num, dai_num, count_waste, manifestnum, recordnum, devicenum, vehiclenum, categories ,statistics ,rfid;
function decimal(num,v)
{
    var vv = Math.pow(10,v);
    return Math.round(num*vv)/vv;
}


$.ajax({
        type: "get",
        url: "{:U('Home/DistrictBusiness/get_chart')}",
        dataType: "json",
        success: function(data) {
            // console.log(data);
            var result=JSON.parse(data);
            // console.log(result.str);

            rfid=result.rfid;
            categories=result.categories;
            // statistics=result.statistics;
            // hw_01=result.hw_01;
            // hw_02=result.hw_02;
            // hw_03=result.hw_03;
            // hw_48=result.hw_48;
            // hw_49=result.hw_49;
            p_number=parseInt(result.pnum);
            r_number=parseInt(result.rnum);
            t_number=parseInt(result.tnum);
            manifestnum=parseInt(result.manifestnum);
            recordnum=parseInt(result.recordnum);
            devicenum=parseInt(result.devicenum);
            vehiclenum=parseInt(result.vehiclenum);
            count_waste=parseInt(result.count_waste);
            tong_num=parseFloat(result.tong_num);
            dai_num=parseInt(result.dai_num);
            sum=p_number+r_number+t_number;
            p_ptg=parseFloat(decimal(100*p_number/sum,1));
            r_ptg=parseFloat(decimal(100*r_number/sum,1));
            t_ptg=parseFloat(decimal(100*t_number/sum,1));
    $('#statistics_graph_enterprise_container').highcharts({
        chart: {
            plotBackgroundColor: null,
            plotBorderWidth: null,
            plotShadow: false
        },
        title: {
            text: '企业统计图'
        },
        tooltip: {
            pointFormat: '{series.name}: <b>{point.percentage:.1f}%</b>'
        },
        plotOptions: {
            pie: {
                allowPointSelect: true,
                cursor: 'pointer',
                dataLabels: {
                    enabled: true,
                    color: '#000000',
                    connectorColor: '#000000',
                    format: '<b>{point.name}</b>: {point.percentage:.1f} %'
                }
            }
        },
        series: [{
            type: 'pie',
            name: 'company numbers',
            data: [
                        
                        {
                            name: '生产企业',
                            y: p_ptg,
                            sliced: true,
                            selected: true
                        },
                        ['运输企业',    t_ptg],
                        ['接受企业',     (100-p_ptg-t_ptg) ],
                      
            ]
        }]

    });
    
    

    var colors = Highcharts.getOptions().colors,
        name = 'Waste_Code';
    var data = new Array();
    for (var idx in categories){     
        var unit_name = new Array();
        var total_num = new Array();
        var waste_total = 0;
        var i = 0; 
        for(var x in rfid){
            if(rfid[x]['waste_id']==categories[idx]){
                var z = true;
                waste_total = waste_total + parseFloat(rfid[x]['waste_total']);
                for(var a in unit_name){
                    if(rfid[x]['production_unit_name']==unit_name[a]){
                        total_num[a] = total_num[a] + parseFloat(rfid[x]['waste_total']);
                        z = false;
                        break;
                    } 
                }    
                if(z == false){
                    continue;
                } else{
                    unit_name[i] = rfid[x]['production_unit_name'];
                    total_num[i] = parseFloat(rfid[x]['waste_total']);
                    i++;  
                }    
            }   
        }

        data[idx] = {
            y: waste_total,
            color: colors[idx],
            drilldown: {
                        name: categories[idx],
                        categories: unit_name,
                        data: total_num,
                        color: colors[2]
                    }
        }
          
    };

    function setChart(name, categories, data, color) {
            chart.xAxis[0].setCategories(categories, false);
            chart.series[0].remove(false);
            chart.addSeries({
                name: name,
                data: data,
                color: color || 'white'
            }, false);
            chart.redraw();
        }

    var chart = $('#statistics_graph_waste_container').highcharts({
            chart: {
                type: 'column'
            },
            title: {
                text: 'waste_statistics, March, 2014'
            },
            subtitle: {
                text: 'Click the columns to view details.'
            },
            xAxis: {
                categories: categories
            },
            yAxis: {
                title: {
                    text: 'Percents'
                }
            },
            plotOptions: {
                column: {
                    cursor: 'pointer',
                    point: {
                        events: {
                            click: function() {
                                var drilldown = this.drilldown;
                                if (drilldown) { // drill down
                                    setChart(drilldown.name, drilldown.categories, drilldown.data, drilldown.color);
                                } else { // restore
                                    setChart(name, categories, data);
                                }
                            }
                        }
                    },
                    dataLabels: {
                        enabled: true,
                        color: colors[0],
                        style: {
                            fontWeight: 'bold'
                        },
                        formatter: function() {
                            return this.y;
                        }
                    }
                }
            },
            tooltip: {
                formatter: function() {
                    var point = this.point,
                        s = this.x +':<b>'+ this.y +' 吨</b><br/>';
                    if (point.drilldown) {
                        s += 'Click to view '+ point.category +' company details';
                    } else {
                        s += 'Click to return to waste total statistics';
                    }
                    return s;
                }
            },
            series: [{
                name: name,
                data: data,
                color: 'white'
            }],
            exporting: {
                enabled: false
            }
        })
        .highcharts(); // return chart

    $('#statistics_graph_waste_container_2').highcharts({
        chart: {
            plotBackgroundColor: null,
            plotBorderWidth: null,
            plotShadow: false
        },
        title: {
            text: 'waste_statistics, March, 2014'
        },
        tooltip: {
            pointFormat: '{series.name}: <b>{point.percentage:.1f}%</b>'
        },
        plotOptions: {
            pie: {
                allowPointSelect: true,
                cursor: 'pointer',
                dataLabels: {
                    enabled: true,
                    color: '#000000',
                    connectorColor: '#000000',
                    format: '<b>{point.name}</b>: {point.percentage:.1f} %'
                }
            }
        },
        series: [{
            type: 'pie',
            name: 'Waste_Code',
            data: [
                        
                        {
                            name: 'HW01',
                            y: 0.1,
                            sliced: true,
                            selected: true
                        },
                        ['HW09',    0.3],
                        ['HW13',     0.2 ],
                        ['HW19',    0.1],
                        ['HW23',     0.1 ],
                        ['HW24',    0.05],
                        ['HW27',     0.05 ],
                        ['HW38',    0.05],
                        ['HW30',     0.05],
                      
            ]
        }]

    });

    $('#statistics_table_enterprise_container').dataTable({
        "aaData": [
            /* Reduced data set */
            ["生产企业数量",p_number ],
            ["运输企业数量", t_number],
            ["接受企业数量", r_number],
            ["备案总数", recordnum],
            ["联单总数", manifestnum],
            ["废物类型总数", count_waste],
            ["桶装废物总量", tong_num+" 公斤"],
            ["袋装废物总量", dai_num+" 个"],
            ["硬件设备总数", devicenum],
            ["运输车辆总数", vehiclenum],
        ],
        "aoColumns": [{
            "sTitle": "统计类型"
        }, {
            "sTitle": "统计总数"
        }],
        "iDisplayLength": 10,
        "sPaginationType": "full_numbers",
        "bLengthChange": false,
        "bInfo": false,
        "bFilter": false,
        "bSort": false,
        "oLanguage": {
                "oPaginate": {
                    "sFirst": "首页",
                    "sPrevious": "前一页",
                    "sNext": "后一页",
                    "sLast": "尾页"
                },
                // "sZeroRecords": "没有检索到数据"
                /*"sProcessing": "<img src='./loading.gif' />"*/
            }

    });
},
        error: function(XMLHttpRequest, textStatus, errorThrown) {
            console.log("Error:Ajax_Content_Load" + errorThrown);
            console.log("XMLHttpRequest.status:" + XMLHttpRequest.status);
            console.log("XMLHttpRequest.readyState:" + XMLHttpRequest.readyState);
            console.log("textStatus:" + textStatus);
        }
    });
            // console.log(p_number);

</script>

